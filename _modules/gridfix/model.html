

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>gridfix.model &mdash; GridFix 0.2 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="GridFix 0.2 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> GridFix
          

          
          </a>

          
            
            
              <div class="version">
                0.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">2. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">3. Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">4. Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">5. Module Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">GridFix</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>gridfix.model</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for gridfix.model</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">PIL</span> <span class="k">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="k">import</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">read_table</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="k">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">pandas_version</span>
<span class="kn">from</span> <span class="nn">distutils.version</span> <span class="k">import</span> <span class="n">LooseVersion</span>

<span class="kn">from</span> <span class="nn">scipy.io</span> <span class="k">import</span> <span class="n">whosmat</span><span class="p">,</span> <span class="n">loadmat</span>


<div class="viewcode-block" id="ImageSet"><a class="viewcode-back" href="../../gridfix.html#gridfix.model.ImageSet">[docs]</a><span class="k">class</span> <span class="nc">ImageSet</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Set of images of equal size for masking and Feature creation. </span>

<span class="sd">    Attributes:</span>
<span class="sd">        info (DataFrame): table of image metadata (filenames, size, type...)</span>
<span class="sd">        imageids (list): All unique image IDs in the set</span>
<span class="sd">        label (str): optional label to distinguish between ImageSets</span>
<span class="sd">        mat_var (str): name of MATLAB variable name if imported from .mat</span>
<span class="sd">        mat_contents (list): list of all variable names in .mat if applicable</span>
<span class="sd">        normalize (boolean): True if image data was normalized to 0..1 range</span>
<span class="sd">        preload (boolean): True if images were preloaded into memory</span>
<span class="sd">        size (tuple): image dimensions, specified as (width, height)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">mat_var</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">imageids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                 <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">preload</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create a new ImageSet and add specified images </span>

<span class="sd">        Args:</span>
<span class="sd">            images: one of the following:</span>
<span class="sd">                - path to a single image or .mat file</span>
<span class="sd">                - path to a folder containing image or .mat files</span>
<span class="sd">                - list of image or .mat file names</span>
<span class="sd">                - simple text file, one filename per line</span>
<span class="sd">                - text / CSV file containing columns &#39;filename&#39; and &#39;imageid&#39;</span>
<span class="sd">            mat_var (str): variable to use if _images_ is a MATLAB file</span>
<span class="sd">            size (tuple): image dimensions, specified as (width, height) in pixels</span>
<span class="sd">            imageids (list): string ID labels, one for each image. If not specified,</span>
<span class="sd">                file names without extension or a numerical label 0..n will be used</span>
<span class="sd">            sep (str): if _images_ is a text file, use this separator</span>
<span class="sd">            label (string): optional descriptive label</span>
<span class="sd">            normalize (boolean): normalize image color / luminance values to 0...1</span>
<span class="sd">                (defaults to True for images, False for MATLAB data)</span>
<span class="sd">            norm_range (tuple): normalization range. Defaults to (0, 255) for image</span>
<span class="sd">                files and per-image (min, max) for data read from MATLAB files</span>
<span class="sd">            preload (boolean): if True, load all images at creation time</span>
<span class="sd">                (faster, but uses a lot of memory)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imageids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_images</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># DF to hold image metadata</span>
        <span class="n">df_col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;imageid&#39;</span><span class="p">,</span> <span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="s1">&#39;channels&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;mat_var&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">df_col</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span> <span class="o">=</span> <span class="n">normalize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_range</span> <span class="o">=</span> <span class="n">norm_range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preload</span> <span class="o">=</span> <span class="n">preload</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_image</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_imageid</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mat_var</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mat_contents</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_images</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">mat_var</span><span class="p">,</span> <span class="n">imageids</span><span class="p">,</span> <span class="n">sep</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Short string representation for printing &quot;&quot;&quot;</span>
        <span class="c1"># Image size</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="s1">&#39;undefined&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

        <span class="c1"># Number of images</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageids</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;s&#39;</span>

        <span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39; &quot;</span><span class="si">{:s}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">))</span>

        <span class="n">mat</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat_var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="s1">&#39;, mat_var=</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat_var</span><span class="p">)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="s1">&#39;, normalized&#39;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="s1">&#39;&lt;gridfix.ImageSet</span><span class="si">{:s}</span><span class="s1">, </span><span class="si">{:d}</span><span class="s1"> image</span><span class="si">{:s}</span><span class="s1">, size=</span><span class="si">{:s}{:s}{:s}</span><span class="s1">&gt;&#39;</span>
        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageids</span><span class="p">),</span> <span class="n">s</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Overload len(ImageSet) to report number of images. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageids</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Overload iteration to step through the ndarray representations of images. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>


    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imageid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Allow to retrieve image by bracket indexing &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">imageid</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_add_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">mat_var</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">imageids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add one or more image(s) to set. </span>

<span class="sd">        Args:</span>
<span class="sd">            images: one of the following: </span>
<span class="sd">                - path to a single image file</span>
<span class="sd">                - path to a folder containing image files</span>
<span class="sd">                - list of image file names</span>
<span class="sd">                - simple text file, one image filename per line</span>
<span class="sd">                - text / CSV file containing columns &#39;filename&#39; and &#39;imageid&#39;</span>
<span class="sd">            mat_var (str): variable to use if _images_ is a MATLAB file</span>
<span class="sd">            imageids (list): string ID labels, one for each image. If not specified,</span>
<span class="sd">                file names without extension or a numerical label 0..n will be used</span>
<span class="sd">            sep (str): if _images_ is a text file, use this separator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filelist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">imageids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">imageids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">img_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

        <span class="c1"># Build file list</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">filelist</span> <span class="o">=</span> <span class="n">images</span>
        
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">images</span><span class="p">):</span>
                <span class="c1"># Directory</span>
                <span class="n">filelist</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">images</span><span class="p">))]</span>

            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">images</span><span class="p">):</span>
                <span class="c1"># Single file - check if it is a text list of images!</span>
                <span class="p">(</span><span class="n">ifname</span><span class="p">,</span> <span class="n">ifext</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">ifext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;.tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;.dat&#39;</span><span class="p">]:</span>
                    <span class="c1"># assume image list</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">imgfiles</span> <span class="o">=</span> <span class="n">read_table</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">imgfiles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="c1"># Only one column: assume no headers and load as list of filenames</span>
                            <span class="n">filelist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">imgfiles</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>

                        <span class="k">elif</span> <span class="n">imgfiles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="c1"># More than one column: look for &#39;imageid&#39; and &#39;filename&#39; columns</span>
                            <span class="k">if</span> <span class="s1">&#39;imageid&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">imgfiles</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span> <span class="ow">and</span> <span class="s1">&#39;filename&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">imgfiles</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]):</span>
                                <span class="n">imgfiles</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">imgfiles</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
                                <span class="n">imgfiles</span> <span class="o">=</span> <span class="n">imgfiles</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span>
                                <span class="n">filelist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">imgfiles</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">])</span>
                                <span class="n">imageids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">imgfiles</span><span class="p">[</span><span class="s1">&#39;imageid&#39;</span><span class="p">])</span>

                        <span class="n">lfolder</span><span class="p">,</span> <span class="n">lname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lfolder</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">img_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">lfolder</span><span class="p">)</span>

                    <span class="k">except</span><span class="p">:</span> 
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;could not read image list file, check format!&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># assume single image file</span>
                    <span class="n">filelist</span> <span class="o">=</span> <span class="p">[</span><span class="n">images</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;first argument must be list or a string containing a file or directory!&#39;</span><span class="p">)</span>

        <span class="c1"># Verify image files</span>
        <span class="n">filetable</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">ifile</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filelist</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">imeta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_image</span><span class="p">(</span><span class="n">ifile</span><span class="p">,</span> <span class="n">mat_var</span><span class="p">,</span> <span class="n">img_root</span><span class="p">)</span>

                <span class="c1"># assign imageid</span>
                <span class="p">(</span><span class="n">ifdir</span><span class="p">,</span> <span class="n">iffile</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ifile</span><span class="p">)</span>
                <span class="p">(</span><span class="n">ifbase</span><span class="p">,</span> <span class="n">ifext</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">iffile</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">imageids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">imageids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">imageid</span> <span class="o">=</span> <span class="n">imageids</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">imageid</span> <span class="o">=</span> <span class="n">iffile</span>
                <span class="n">imeta</span><span class="p">[</span><span class="s1">&#39;imageid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imageid</span>

                <span class="k">if</span> <span class="n">imageid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageids</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: replacing existing image with ID &lt;</span><span class="si">{:s}</span><span class="s1">&gt;!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imageid</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imageids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imageid</span><span class="p">)</span>

                <span class="n">filetable</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imeta</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: file </span><span class="si">{:s}</span><span class="s1"> could not be added, error: </span><span class="si">{:s}</span><span class="s1">!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ifile</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>

        <span class="n">df_col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;imageid&#39;</span><span class="p">,</span> <span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="s1">&#39;channels&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;mat_var&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">filetable</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">df_col</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imageids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">imageid</span><span class="p">)</span>

        <span class="c1"># Preload files if requested</span>
        <span class="k">for</span> <span class="n">imid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageids</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_images</span><span class="p">[</span><span class="n">imid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_image</span><span class="p">(</span><span class="n">imid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_images</span><span class="p">[</span><span class="n">imid</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="ImageSet.image"><a class="viewcode-back" href="../../gridfix.html#gridfix.model.ImageSet.image">[docs]</a>    <span class="k">def</span> <span class="nf">image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imageid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get image by imageid, loading it if not preloaded</span>

<span class="sd">        Args:</span>
<span class="sd">            imageid (str): valid imageid from set</span>

<span class="sd">        Returns:</span>
<span class="sd">            ndarray of raw image data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">imageid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageids</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Specified _imageid_ does not exist!&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_images</span><span class="p">[</span><span class="n">imageid</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_images</span><span class="p">[</span><span class="n">imageid</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_imageid</span> <span class="o">==</span> <span class="n">imageid</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_image</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_image</span><span class="p">(</span><span class="n">imageid</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imageid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Load and return image data for imageid. </span>

<span class="sd">        Args:</span>
<span class="sd">            imageid (str): valid imageid from set</span>

<span class="sd">        Returns:</span>
<span class="sd">            ndarray of raw image data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">imageid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageids</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Specified _imageid_ does not exist!&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_imageid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_imageid</span> <span class="o">==</span> <span class="n">imageid</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_image</span>

        <span class="n">imdata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">imeta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">imageid</span> <span class="o">==</span> <span class="n">imageid</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imeta</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">imeta</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MAT&#39;</span><span class="p">:</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="n">loadmat</span><span class="p">(</span><span class="n">imeta</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">variable_names</span><span class="o">=</span><span class="n">imeta</span><span class="o">.</span><span class="n">mat_var</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">imdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">imeta</span><span class="o">.</span><span class="n">mat_var</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">imeta</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;RGBA&#39;</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>    <span class="c1"># Drop alpha channel</span>
                <span class="n">imdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">imeta</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;MAT&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">imdata</span> <span class="o">=</span> <span class="n">imdata</span> <span class="o">/</span> <span class="mf">255.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">imdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">imdata</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">imdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">imdata</span> <span class="o">-</span> <span class="n">imdata</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">imdata</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">imdata</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">imdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">imdata</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_last_imageid</span> <span class="o">=</span> <span class="n">imageid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_image</span> <span class="o">=</span> <span class="n">imdata</span>

        <span class="k">return</span> <span class="n">imdata</span>


    <span class="k">def</span> <span class="nf">_verify_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_file</span><span class="p">,</span> <span class="n">mat_var</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">img_root</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Verify type and size of image without actually loading data</span>

<span class="sd">        Args: </span>
<span class="sd">            image_file (str): path to image file to verify</span>
<span class="sd">            mat_var (str): optional variable name for MATLAB files</span>
<span class="sd">            img_root (str): folder containing image list in case file paths are relative</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict of metadata, column names as in imageset.info DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">image_file</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">img_root</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_root</span><span class="p">,</span> <span class="n">image_file</span><span class="p">)):</span>
                <span class="n">image_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_root</span><span class="p">,</span> <span class="n">image_file</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;file not found&#39;</span><span class="p">)</span>

        <span class="p">(</span><span class="n">ifbase</span><span class="p">,</span> <span class="n">ifext</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span>

        <span class="n">imeta</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;imageid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                 <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> 
                 <span class="s1">&#39;channels&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> 
                 <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="s1">&#39;mat_var&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        
        <span class="c1"># Matlab files</span>
        <span class="k">if</span> <span class="n">ifext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;.mat&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Load .mat header and identify variables</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">whosmat</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span>
                <span class="n">tmpvars</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat_contents</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mat_contents</span> <span class="o">=</span> <span class="n">tmpvars</span>
                
                <span class="k">if</span> <span class="n">mat_var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
                    <span class="n">mat_var</span> <span class="o">=</span> <span class="n">tmpvars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">mat_var</span> <span class="ow">in</span> <span class="n">tmpvars</span><span class="p">:</span>
                    
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat_var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mat_var</span> <span class="o">=</span> <span class="n">mat_var</span>

                    <span class="c1"># check image size</span>
                    <span class="n">imshape</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">tmp</span> <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">mat_var</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">imshape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">imshape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">imshape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">imshape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                        <span class="n">imeta</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_file</span>
                        <span class="n">imeta</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">imeta</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imshape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">imeta</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imshape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">imeta</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="n">imeta</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;MAT&#39;</span>
                        <span class="n">imeta</span><span class="p">[</span><span class="s1">&#39;mat_var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_var</span>
                    
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="s1">&#39;Warning: skipping </span><span class="si">{:s}</span><span class="s1"> due to image size (</span><span class="si">{:d}</span><span class="s1">x</span><span class="si">{:d}</span><span class="s1"> instead of </span><span class="si">{:d}</span><span class="s1">x</span><span class="si">{:d}</span><span class="s1">).&#39;</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iffile</span><span class="p">,</span> <span class="n">imsize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">imsize</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;specified MATLAB variable not in file&#39;</span><span class="p">)</span>

            <span class="k">except</span><span class="p">:</span> 
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;error loading MATLAB data&#39;</span><span class="p">)</span>

        <span class="c1"># Image files</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span> 
                <span class="n">imsize</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">size</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">imsize</span>

                <span class="c1"># check image size</span>
                <span class="k">if</span> <span class="n">imsize</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                    <span class="n">imeta</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_file</span>
                    <span class="n">imeta</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">imeta</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="s1">&#39;RGBA&#39;</span><span class="p">]:</span>
                        <span class="n">imeta</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">imeta</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">imeta</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">format</span>
                    <span class="n">imeta</span><span class="p">[</span><span class="s1">&#39;mat_var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="s1">&#39;Warning: skipping </span><span class="si">{:s}</span><span class="s1"> due to image size (</span><span class="si">{:d}</span><span class="s1">x</span><span class="si">{:d}</span><span class="s1"> instead of </span><span class="si">{:d}</span><span class="s1">x</span><span class="si">{:d}</span><span class="s1">).&#39;</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="n">imsize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">imsize</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;not an image or file could not be opened.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">imeta</span>


<div class="viewcode-block" id="ImageSet.plot"><a class="viewcode-back" href="../../gridfix.html#gridfix.model.ImageSet.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imageid</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">image_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Display one of the contained images by imageid using matplotlib</span>

<span class="sd">        Args:</span>
<span class="sd">            imageid (str): valid imageid of image to show</span>
<span class="sd">            cmap (str): name of a matplotlib colormap to use</span>
<span class="sd">            image_only (boolean): if True, return only image content without labels</span>
<span class="sd">            ax (Axes): axes object to draw on, to include result in other figure</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib figure object, or None if passed an axis to draw on</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax1</span> <span class="o">=</span> <span class="n">ax</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">imageid</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">image_only</span><span class="p">:</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">imageid</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">plt</span><span class="o">.</span><span class="n">isinteractive</span><span class="p">():</span>
                <span class="c1"># Only return figure object in non-interactive mode, otherwise</span>
                <span class="c1"># IPython/Jupyter will display the figure twice (once while plotting</span>
                <span class="c1"># and once as the cell result)!</span>
                <span class="k">return</span> <span class="n">fig</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No image with ID &quot;</span><span class="si">{:s}</span><span class="s1">&quot; in set&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imageid</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="Fixations"><a class="viewcode-back" href="../../gridfix.html#gridfix.model.Fixations">[docs]</a><span class="k">class</span> <span class="nc">Fixations</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dataset of fixation locations.</span>

<span class="sd">    Fixation locations are assumed to be one-indexed in input, e.g. 1..800 if </span>
<span class="sd">    the image is 800 pixels wide, and converted internally to Pythons zero-indexed</span>
<span class="sd">    array convention.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        data (DataFrame): DataFrame of raw fixation data</span>
<span class="sd">        has_times (boolean): True if fixation times have been loaded</span>
<span class="sd">        imageids (list): all unique image IDs represented in the dataset</span>
<span class="sd">        imageset (ImageSet): if present, the associated ImageSet</span>
<span class="sd">        input_file (str): file name of fixation data file</span>
<span class="sd">        num_samples (int): number of fixation samples</span>
<span class="sd">        num_vars (int): number of columns / variables in dataset </span>
<span class="sd">        offset (tuple): optional offset from raw (x,y) positions</span>
<span class="sd">        shape (tuple): dimensions of .data, i.e. same as Fixations.data.shape</span>
<span class="sd">        variables (list): list of all variables loaded from input file</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">imageset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">imageid</span><span class="o">=</span><span class="s1">&#39;imageid&#39;</span><span class="p">,</span> 
                 <span class="n">fixid</span><span class="o">=</span><span class="s1">&#39;fixid&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">fixstart</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fixend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">numericid</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create new Fixations dataset and calculate defaults.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: a predefined DataFrame or name of a file containing fixation report</span>
<span class="sd">            imageset (ImageSet): if present, verify imageids against this ImageSet</span>
<span class="sd">            offset (tuple): an (x, y) tuple of pixel values to offset fixations. E.g.,</span>
<span class="sd">                if fixations have their origin at image center, use (-width/2, -height/2)</span>
<span class="sd">            imageid (str): name of data file column containing imageids</span>
<span class="sd">            fixid (str): name of data file column with unique fixation ID / index</span>
<span class="sd">            x (str): name of data file column for horizontal fixation locations</span>
<span class="sd">            y (str): name of data file column for vertical fixation locations</span>
<span class="sd">            fixstart (str): name of data file column containing fixation start time</span>
<span class="sd">            fixend (str): name of data file column containing fixation end time</span>
<span class="sd">            numericid (boolean): if True, try to force parsing imageid as numeric</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DataFrame</span><span class="p">):</span>
            <span class="c1"># data is already a DataFrame</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_file</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">read_table</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">input_file</span> <span class="o">=</span> <span class="n">data</span>

            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Could not load fixation data, check file name and type!&#39;</span><span class="p">)</span>

        <span class="c1"># Internal column names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_imageid</span> <span class="o">=</span> <span class="n">imageid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixid</span> <span class="o">=</span> <span class="n">fixid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xpx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">+</span> <span class="s1">&#39;_PX&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ypx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">+</span> <span class="s1">&#39;_PX&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixstart</span> <span class="o">=</span> <span class="n">fixstart</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixend</span> <span class="o">=</span> <span class="n">fixend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixdur</span> <span class="o">=</span> <span class="s1">&#39;__FIXDUR&#39;</span>

        <span class="c1"># Verify that all required columns are present</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">imageid</span><span class="p">,</span> <span class="n">fixid</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
        <span class="n">miss_cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="n">miss_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">miss_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Missing columns (</span><span class="si">{:s}</span><span class="s1">), please specify column names!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">miss_cols</span><span class="p">)))</span>
            
        <span class="c1"># Image ID column should always be converted to strings</span>
        <span class="k">if</span> <span class="n">numericid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_imageid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_imageid</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_imageid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_imageid</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">imageids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_imageid</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="c1"># Fixation timing columns (optional, default: not specified)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_times</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">fixstart</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fixend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fixstart</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown column specified for fixation start time: &quot;</span><span class="si">{:s}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fixstart</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">fixend</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown column specified for fixation end time: &quot;</span><span class="si">{:s}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fixend</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">has_times</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_fixdur</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_fixend</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_fixstart</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fixstart</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">fixend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Optional timing columns (fixstart, fixend) must be specified together!&#39;</span><span class="p">)</span>

        <span class="c1"># If ImageSet provided, check if all images are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imageset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">imageset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imageset</span> <span class="o">=</span> <span class="n">imageset</span>
            <span class="n">missing_imgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">im</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">imageset</span><span class="o">.</span><span class="n">imageids</span><span class="p">:</span>
                    <span class="n">missing_imgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_imgs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: the following images appear in the fixation data but not the speficied ImageSet: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_imgs</span><span class="p">)))</span>

        <span class="c1"># Set offset and calculate pixel indices (_xpx, _ypx)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_offset</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; String representation &quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="s1">&#39;&lt;gridfix.Fixations data set, </span><span class="si">{:d}</span><span class="s1"> samples, </span><span class="si">{:d}</span><span class="s1"> images&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageids</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Images:</span><span class="se">\n\t</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageset</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">r</span>


    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Overload len() to report the number of samples &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imageid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Bracket indexing returns all fixations for a specified image &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_fix</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;imageid&#39;</span><span class="p">:</span> <span class="n">imageid</span><span class="p">})</span>


<div class="viewcode-block" id="Fixations.set_offset"><a class="viewcode-back" href="../../gridfix.html#gridfix.model.Fixations.set_offset">[docs]</a>    <span class="k">def</span> <span class="nf">set_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set a constant offset for eye x/y coordinates.</span>

<span class="sd">        If image coordinates are relative to image center, use (-width/2, -height/2)</span>
<span class="sd">        (GridFix uses a coordinate origin at the top left).</span>

<span class="sd">        Args:</span>
<span class="sd">            offset (tuple): 2-tuple of (hor, ver) offset values in pixels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Reset previous offset</span>
        <span class="n">prevoffset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>
        <span class="k">if</span> <span class="n">prevoffset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">prevoffset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">]</span> <span class="o">-</span> <span class="n">prevoffset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">]</span> <span class="o">-</span> <span class="n">prevoffset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">]</span> <span class="o">+</span> <span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">]</span> <span class="o">+</span> <span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Round x/y fixation positions to integers (pixels) while keeping original data</span>
        <span class="c1"># Note: we&#39;re going to use these as indices and Python is 0-indexed, so subtract 1!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_xpx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ypx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="Fixations.select_fix"><a class="viewcode-back" href="../../gridfix.html#gridfix.model.Fixations.select_fix">[docs]</a>    <span class="k">def</span> <span class="nf">select_fix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot; Return a subset of fixation data for specified imageid.</span>

<span class="sd">        Args:.</span>
<span class="sd">            select (dict): dict of filter variables, as {column: value}</span>

<span class="sd">        Returns:</span>
<span class="sd">            New Fixations object containing selected fixations only</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imageid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">select</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: no image ID in filter variables, selection will yield fixations from multiple images! Proceed at own risk.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">select</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_imageid</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_imageid</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: zero fixations selected for specified imageid (</span><span class="si">{:s}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">select</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_imageid</span><span class="p">]))</span>

        <span class="n">selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">select</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">select</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selection</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: filter variable </span><span class="si">{:s}</span><span class="s1"> not found in Fixations dataset!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Make sure dict value is list-like</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">target</span> <span class="o">=</span> <span class="p">[</span><span class="n">target</span><span class="p">]</span>
                    <span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="n">selection</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">target</span><span class="p">)]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">Fixations</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">imageid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_imageid</span><span class="p">,</span> <span class="n">fixid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fixid</span><span class="p">,</span>
                           <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">,</span> <span class="n">imageset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imageset</span><span class="p">,</span>
                           <span class="n">fixstart</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fixstart</span><span class="p">,</span> <span class="n">fixend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fixend</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="Fixations.plot"><a class="viewcode-back" href="../../gridfix.html#gridfix.model.Fixations.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imageid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="p">{},</span> <span class="n">on_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">oob</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">plotformat</span><span class="o">=</span><span class="s1">&#39;wo&#39;</span><span class="p">,</span> <span class="n">durations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">image_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot fixations for selected imageid, either alone or on image</span>

<span class="sd">        Args:</span>
<span class="sd">            imageid (str): optional image ID to plot fixations for</span>
<span class="sd">            select (dict): dict of additional filter variables (see select_fix())</span>
<span class="sd">            image (bool): if True, superimpose fixations onto image (if ImageSet present)</span>
<span class="sd">            oob (bool): if True, include out-of-bounds fixations when plotting</span>
<span class="sd">            plotformat (str): format string for plt.pyplot.plot(), default: white circles</span>
<span class="sd">            durations (bool): if True, plot duration of each fixation next to marker</span>
<span class="sd">            image_only (boolean): if True, return only image content without labels</span>
<span class="sd">            ax (Axes): axes object to draw to, to include result in other figure</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib figure object, or None if passed an axis to draw on</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">imageid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">imageid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">select</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">select</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_imageid</span><span class="p">]</span> <span class="o">=</span> <span class="n">imageid</span>
            <span class="n">plotfix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_fix</span><span class="p">(</span><span class="n">select</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plotfix</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">ax</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">on_image</span><span class="p">:</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageset</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">imageid</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;upper&#39;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: cannot view fixations on image due to missing ImageSet!&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">oob</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plotfix</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_xpx</span><span class="p">],</span> <span class="n">plotfix</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ypx</span><span class="p">],</span> <span class="n">plotformat</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">durations</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">plotfix</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_xpx</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_ypx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_ypx</span><span class="p">]</span> <span class="o">-</span> <span class="mi">15</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_ypx</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_fixdur</span><span class="p">]</span>
                    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageset</span><span class="o">.</span><span class="n">size</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">plotfix</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_xpx</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">plotfix</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ypx</span><span class="p">]))</span>
                <span class="n">fix</span> <span class="o">=</span> <span class="n">plotfix</span><span class="o">.</span><span class="n">data</span><span class="p">[(</span><span class="n">plotfix</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_xpx</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
                                   <span class="p">(</span><span class="n">plotfix</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_xpx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span>
                                   <span class="p">(</span><span class="n">plotfix</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ypx</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
                                   <span class="p">(</span><span class="n">plotfix</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ypx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fix</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_xpx</span><span class="p">],</span> <span class="n">fix</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ypx</span><span class="p">],</span> <span class="n">plotformat</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">durations</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">fix</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_xpx</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_ypx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
                            <span class="n">y</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_ypx</span><span class="p">]</span> <span class="o">-</span> <span class="mi">15</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">y</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_ypx</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_fixdur</span><span class="p">]</span>
                        <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

                <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">image_only</span><span class="p">:</span>
                    <span class="n">ax1</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">imageid</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: cannot filter fixations for image boundaries due to missing ImageSet!&#39;</span><span class="p">)</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plotfix</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_xpx</span><span class="p">],</span> <span class="n">plotfix</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ypx</span><span class="p">],</span> <span class="n">plotformat</span><span class="p">)</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">plt</span><span class="o">.</span><span class="n">isinteractive</span><span class="p">():</span>  <span class="c1"># see ImageSet.plot()</span>
            <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="Fixations.location_map"><a class="viewcode-back" href="../../gridfix.html#gridfix.model.Fixations.location_map">[docs]</a>    <span class="k">def</span> <span class="nf">location_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imageid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Binary ndarray of fixated and non-fixated pixels within image area</span>

<span class="sd">        Args:</span>
<span class="sd">            imageid (str): optional image ID to create map for one image only</span>
<span class="sd">            size (tuple): image dimensions, specified as (width, height).</span>

<span class="sd">        Returns:</span>
<span class="sd">            2d boolean ndarray, True where fixated, otherwise False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">imageid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mapfix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_fix</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">_imageid</span><span class="p">:</span> <span class="n">imageid</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mapfix</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageset</span><span class="o">.</span><span class="n">size</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Image size or attached ImageSet are necessary for location mapping!&#39;</span><span class="p">)</span>

        <span class="n">fixloc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">fix</span> <span class="o">=</span> <span class="n">mapfix</span><span class="o">.</span><span class="n">data</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_xpx</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_xpx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span>
                          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ypx</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ypx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">fixloc</span><span class="p">[</span><span class="n">fix</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ypx</span><span class="p">],</span> <span class="n">fix</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_xpx</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">fixloc</span></div>


<div class="viewcode-block" id="Fixations.count_map"><a class="viewcode-back" href="../../gridfix.html#gridfix.model.Fixations.count_map">[docs]</a>    <span class="k">def</span> <span class="nf">count_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imageid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Map of fixation counts for each image pixel</span>

<span class="sd">        Args:</span>
<span class="sd">            imageid (str): optional image ID to create map for one image only</span>
<span class="sd">            size (tuple): image dimensions, specified as (width, height).</span>

<span class="sd">        Returns:</span>
<span class="sd">            2d ndarray of pixel fixation counts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">imageid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mapfix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_fix</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">_imageid</span><span class="p">:</span> <span class="n">imageid</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mapfix</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageset</span><span class="o">.</span><span class="n">size</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Image size or attached ImageSet are necessary for location mapping!&#39;</span><span class="p">)</span>

        <span class="n">fixcount</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">fix</span> <span class="o">=</span> <span class="n">mapfix</span><span class="o">.</span><span class="n">data</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_xpx</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_xpx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span>
                          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ypx</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ypx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">fixloc</span> <span class="o">=</span> <span class="n">fix</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ypx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xpx</span><span class="p">]]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">fixloc</span><span class="p">:</span>
            <span class="n">fixcount</span><span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">fixcount</span></div>



<div class="viewcode-block" id="Fixations.dur_map"><a class="viewcode-back" href="../../gridfix.html#gridfix.model.Fixations.dur_map">[docs]</a>    <span class="k">def</span> <span class="nf">dur_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imageid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Map of total fixation durations for each image pixel</span>

<span class="sd">        Args:</span>
<span class="sd">            imageid (str): optional image ID to create map for one image only</span>
<span class="sd">            size (tuple): image dimensions, specified as (width, height).</span>

<span class="sd">        Returns:</span>
<span class="sd">            2d ndarray of fixation durations at each pixel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">imageid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mapfix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_fix</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">_imageid</span><span class="p">:</span> <span class="n">imageid</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mapfix</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageset</span><span class="o">.</span><span class="n">size</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Image size or attached ImageSet are necessary for location mapping!&#39;</span><span class="p">)</span>

        <span class="n">durmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">fix</span> <span class="o">=</span> <span class="n">mapfix</span><span class="o">.</span><span class="n">data</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_xpx</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_xpx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span>
                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ypx</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ypx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">fix</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">durmap</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_ypx</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_xpx</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_fixdur</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">durmap</span></div></div>



<div class="viewcode-block" id="FixationModel"><a class="viewcode-back" href="../../gridfix.html#gridfix.model.FixationModel">[docs]</a><span class="k">class</span> <span class="nc">FixationModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Combines Features and Fixations to create predictors and R source for GLMM</span>

<span class="sd">    Attributes:</span>
<span class="sd">        chunks (list): list of data columns that define chunks (e.g., subjects or sessions)</span>
<span class="sd">        comp_features (dict): dict of labelled feature comparisons. Predictors will be replicated</span>
<span class="sd">            for each feature in a comparison so that features can serve as fixed or random factor</span>
<span class="sd">        exclude_first_fix (boolean): if True, first fixation index was set NaN (e.g.,, fixation cross)</span>
<span class="sd">        features (dict): dictionary of feature objects and feature groups</span>
<span class="sd">        predictors (DataFrame): model predictors for GLMM</span>
<span class="sd">        regionset (RegionSet): attached RegionSet</span>
<span class="sd">        runtime (float): time in seconds for most recent update of predictor matrix</span>
<span class="sd">        normalize_features (bool): if True, feature values are normalized to 0..1 range</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fixations</span><span class="p">,</span> <span class="n">regionset</span><span class="p">,</span> <span class="n">dv_type</span><span class="o">=</span><span class="s1">&#39;fixated&#39;</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">feature_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">chunks</span><span class="o">=</span><span class="p">[],</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exclude_first_fix</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize_features</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create a new FixationModel.</span>

<span class="sd">        Args:</span>
<span class="sd">            fixations (Fixations): fixation data to use as model DV (column &#39;fixation&#39;)</span>
<span class="sd">            regionset (RegionSet): a RegionSet object defining length of all features</span>
<span class="sd">            dv_type (str): type of DV to generate, or list of multiple options:</span>
<span class="sd">                &#39;fixated&#39;: binary coding of fixated (1) and unfixated (0) regions</span>
<span class="sd">                &#39;count&#39;: absolute fixation count for each region</span>
<span class="sd">            features (list): list of Feature objects to add (use add_comparison for feature groups)</span>
<span class="sd">            feature_labels (list): string labels to apply to features defined using features= attribute</span>
<span class="sd">            chunks (list): list of fixation data columns that define chunks (e.g., subjects or sessions)</span>
<span class="sd">            progress (bool): print current image and group variables to indicate model build progress</span>
<span class="sd">            exclude_first_fix (bool): if True, set first fixated region per image to NaN for GLMM</span>
<span class="sd">            normalize_features (bool): if True, normalize feature values to 0..1 range</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regionset</span> <span class="o">=</span> <span class="n">regionset</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fix</span> <span class="o">=</span> <span class="n">fixations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pred</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_consistent</span> <span class="o">=</span> <span class="kc">False</span>    <span class="c1"># Flags whether we need to rebuild predictor matrix</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comp_features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalize_features</span> <span class="o">=</span> <span class="n">normalize_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclude_first_fix</span> <span class="o">=</span> <span class="n">exclude_first_fix</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dv_type</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">dv_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">dv_type</span><span class="p">,]</span>
        <span class="k">for</span> <span class="n">dvt</span> <span class="ow">in</span> <span class="n">dv_type</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dvt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fixated&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Error: unknown DV type specified: &quot;</span><span class="si">{:s}</span><span class="s1">&quot;!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dvt</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dv_type</span> <span class="o">=</span> <span class="n">dv_type</span>

        <span class="c1"># Make sure imageid is always a chunking variable and all chunk vars exist</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fix</span><span class="o">.</span><span class="n">_imageid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
            <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fix</span><span class="o">.</span><span class="n">_imageid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fix</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Error: chunking variable &quot;</span><span class="si">{:s}</span><span class="s1">&quot; does not exist in dataset!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span> <span class="o">=</span> <span class="n">chunks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">progress</span>

        <span class="c1"># Add any specified features to model</span>
        <span class="k">if</span> <span class="n">features</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">tuple</span><span class="p">:</span>
                <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">features</span><span class="p">,]</span>  <span class="c1"># force list of features</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">feature_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_labels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">feature_labels</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
                    <span class="n">label</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feat_label</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">progress</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_feat_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create label for unlabeled Feature object.&quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;f&#39;</span> <span class="o">+</span> <span class="bp">cls</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>

        <span class="n">f_label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">while</span> <span class="n">f_label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">f_label</span> <span class="o">=</span> <span class="n">label</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>
            <span class="n">suffix</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">f_label</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">predictors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Model predictor matrix, updated if necessary &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consistent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pred</span>


    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; String representation for print summary. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consistent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="n">r</span> <span class="o">=</span> <span class="s1">&#39;&lt;gridfix.FixationModel, </span><span class="si">{:d}</span><span class="s1"> samples, DV=</span><span class="si">{:s}</span><span class="s1">, chunked by: </span><span class="si">{:s}</span><span class="s1">&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predictors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dv_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="s1">&#39;Fixations:</span><span class="se">\n\t</span><span class="si">{:s}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fix</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="s1">&#39;Regions:</span><span class="se">\n\t</span><span class="si">{:s}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regionset</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Features:</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">r</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="si">{:s}</span><span class="se">\t</span><span class="si">{:s}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Feature Comparisons:</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp_features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">r</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">r</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="si">{:s}</span><span class="se">\t</span><span class="si">{:s}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">code</span><span class="p">),</span> <span class="n">feat</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>


<div class="viewcode-block" id="FixationModel.r_source"><a class="viewcode-back" href="../../gridfix.html#gridfix.model.FixationModel.r_source">[docs]</a>    <span class="k">def</span> <span class="nf">r_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datafile</span><span class="o">=</span><span class="s1">&#39;gridfix.csv&#39;</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                 <span class="n">optimizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">random_slopes</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generate R source code from current feature settings.</span>

<span class="sd">        Args:</span>
<span class="sd">            datafile (str): predictor matrix file name (for R import via read.table())</span>
<span class="sd">            comments (boolean): if True, add explanatory comments and headers to source</span>
<span class="sd">            scale (boolean): if True, add code to scale (normalize) feature predictors</span>
<span class="sd">            center (boolean): if True, add code to center (demean) feature predictors</span>
<span class="sd">            optimizer (str): optional optimizer to pass to R glmer()</span>
<span class="sd">            fixed (list): list of column names (strings) to add as fixed factors</span>
<span class="sd">            random (list): list of column names (strings) to add as random factors</span>
<span class="sd">            random_slopes (boolean): also add random slopes to generated R code</span>

<span class="sd">        Returns:</span>
<span class="sd">            R source code as string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r_libs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lme4&#39;</span><span class="p">]</span>

        <span class="n">src</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">comments</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">.%m.%y, %H:%M:%S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">())</span>
            <span class="n">src</span> <span class="o">=</span>  <span class="s1">&#39;# GridFix GLMM R source, generated on </span><span class="si">{:s}</span><span class="se">\n</span><span class="s1"># </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="n">src</span> <span class="o">+=</span> <span class="s1">&#39;# Predictor file:</span><span class="se">\t</span><span class="si">{:s}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
            <span class="n">src</span> <span class="o">+=</span> <span class="s1">&#39;# Fixations file:</span><span class="se">\t</span><span class="si">{:s}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fix</span><span class="o">.</span><span class="n">input_file</span><span class="p">))</span>
            <span class="n">src</span> <span class="o">+=</span> <span class="s1">&#39;# RegionSet:</span><span class="se">\t\t</span><span class="si">{:s}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regionset</span><span class="p">))</span>
            <span class="n">src</span> <span class="o">+=</span> <span class="s1">&#39;# DV type(s):</span><span class="se">\t\t</span><span class="si">{:s}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dv_type</span><span class="p">))</span>
            <span class="n">src</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="c1"># Libraries</span>
        <span class="k">for</span> <span class="n">lib</span> <span class="ow">in</span> <span class="n">r_libs</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">+=</span> <span class="s1">&#39;library(</span><span class="si">{:s}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lib</span><span class="p">)</span>
        <span class="n">src</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="c1"># Predictor file</span>
        <span class="n">src</span> <span class="o">+=</span> <span class="s1">&#39;gridfixdata  &lt;- read.table(&quot;</span><span class="si">{:s}</span><span class="s1">&quot;, header=T, sep=&quot;</span><span class="se">\\</span><span class="s1">t&quot;, row.names=NULL)</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>

        <span class="c1"># Factors</span>
        <span class="k">if</span> <span class="n">comments</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">+=</span> <span class="s1">&#39;# Define R factors for all chunking variables and group dummy codes</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">+=</span> <span class="s1">&#39;gridfixdata$</span><span class="si">{:s}</span><span class="s1"> &lt;- as.factor(gridfixdata$</span><span class="si">{:s}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp_features</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">src</span> <span class="o">+=</span> <span class="s1">&#39;gridfixdata$</span><span class="si">{:s}</span><span class="s1"> &lt;- as.factor(gridfixdata$</span><span class="si">{:s}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cf</span><span class="p">,</span> <span class="n">cf</span><span class="p">)</span>
        <span class="n">src</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="c1"># Center and scale</span>
        <span class="k">if</span> <span class="n">scale</span> <span class="ow">or</span> <span class="n">center</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">r_cent</span> <span class="o">=</span> <span class="s1">&#39;FALSE&#39;</span>
                <span class="n">r_scal</span> <span class="o">=</span> <span class="s1">&#39;FALSE&#39;</span>
                <span class="k">if</span> <span class="n">center</span><span class="p">:</span>
                    <span class="n">r_cent</span> <span class="o">=</span> <span class="s1">&#39;TRUE&#39;</span>
                <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
                    <span class="n">r_scal</span> <span class="o">=</span> <span class="s1">&#39;TRUE&#39;</span>
                <span class="k">if</span> <span class="n">comments</span><span class="p">:</span>
                    <span class="n">src</span> <span class="o">+=</span> <span class="s1">&#39;# Center and scale predictors</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">src</span> <span class="o">+=</span> <span class="s1">&#39;gridfixdata$</span><span class="si">{:s}</span><span class="s1">_C &lt;- scale(gridfixdata$</span><span class="si">{:s}</span><span class="s1">, center=</span><span class="si">{:s}</span><span class="s1">, scale=</span><span class="si">{:s}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">r_cent</span><span class="p">,</span> <span class="n">r_scal</span><span class="p">)</span>
                <span class="n">src</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="c1"># GLMM model formula (DV is set later)</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1"> ~ 1&#39;</span>

        <span class="k">if</span> <span class="n">fixed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Best guess: all simple features should be fixed factors!</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fixed</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">fixed_vars</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fixed</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># likely a feature object</span>
                <span class="n">fl</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="c1"># text label specified</span>
                <span class="n">fl</span> <span class="o">=</span> <span class="n">f</span>
            <span class="k">if</span> <span class="n">scale</span> <span class="ow">or</span> <span class="n">center</span><span class="p">:</span>
                <span class="n">fixed_vars</span> <span class="o">+=</span> <span class="s1">&#39; + </span><span class="si">{:s}</span><span class="s1">_C &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fixed_vars</span> <span class="o">+=</span> <span class="s1">&#39; + </span><span class="si">{:s}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span>
        <span class="n">formula</span> <span class="o">+=</span> <span class="n">fixed_vars</span>

        <span class="k">if</span> <span class="n">random</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># imageid should be a random factor by default</span>
            <span class="n">random</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_fix</span><span class="o">.</span><span class="n">_imageid</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fixed</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">random</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                <span class="c1"># likely a feature object</span>
                    <span class="n">rl</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">label</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">rl</span> <span class="o">=</span> <span class="n">r</span>
                <span class="k">if</span> <span class="n">random_slopes</span><span class="p">:</span>
                    <span class="n">formula</span> <span class="o">+=</span> <span class="s1">&#39; + (1</span><span class="si">{:s}</span><span class="s1"> | </span><span class="si">{:s}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fixed_vars</span><span class="p">,</span> <span class="n">rl</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">formula</span> <span class="o">+=</span> <span class="s1">&#39; + (1 | </span><span class="si">{:s}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rl</span><span class="p">)</span>

        <span class="c1"># Optimizer parameter</span>
        <span class="n">opt_call</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">optimizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">opt_call</span> <span class="o">=</span> <span class="s1">&#39;, control=glmerControl(optimizer=&quot;</span><span class="si">{:s}</span><span class="s1">&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)</span>

        <span class="c1"># GLMM model call(s) - one per requested DV</span>
        <span class="k">if</span> <span class="n">comments</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">+=</span> <span class="s1">&#39;# NOTE: this source code can only serve as a scaffolding for your own analysis!</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">src</span> <span class="o">+=</span> <span class="s1">&#39;# You MUST adapt the GLMM model formula below to your model, then uncomment the corresponding line!</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">current_dv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dv_type</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">current_dv</span> <span class="o">==</span> <span class="s1">&#39;fixated&#39;</span><span class="p">:</span>
                <span class="n">model_fam</span> <span class="o">=</span> <span class="s1">&#39;binomial&#39;</span>
                <span class="n">model_dv</span> <span class="o">=</span> <span class="s1">&#39;dvFix&#39;</span>
            <span class="k">elif</span> <span class="n">current_dv</span> <span class="o">==</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span>
                <span class="n">model_fam</span> <span class="o">=</span> <span class="s1">&#39;poisson&#39;</span>
                <span class="n">model_dv</span> <span class="o">=</span> <span class="s1">&#39;dvCount&#39;</span>
            <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;model.</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current_dv</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">comments</span><span class="p">:</span>
                <span class="n">src</span> <span class="o">+=</span> <span class="s1">&#39;# DV: </span><span class="si">{:s}</span><span class="se">\n</span><span class="s1">#&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current_dv</span><span class="p">)</span>

            <span class="n">src</span> <span class="o">+=</span> <span class="s1">&#39;model.</span><span class="si">{:s}</span><span class="s1"> &lt;- glmer(</span><span class="si">{:s}</span><span class="s1">, data=gridfixdata</span><span class="si">{:s}</span><span class="s1">, family=</span><span class="si">{:s}</span><span class="s1">)</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current_dv</span><span class="p">,</span> <span class="n">formula</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_dv</span><span class="p">),</span> <span class="n">opt_call</span><span class="p">,</span> <span class="n">model_fam</span><span class="p">)</span>

        <span class="n">out_f</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
        <span class="n">r_objlist</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&quot;</span><span class="si">{:s}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">models</span><span class="p">])</span>
        <span class="n">src</span> <span class="o">+=</span> <span class="s1">&#39;save(file=&quot;</span><span class="si">{}</span><span class="s1">_GLMM.Rdata&quot;, list = c(</span><span class="si">{:s}</span><span class="s1">))</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_f</span><span class="p">,</span> <span class="n">r_objlist</span><span class="p">)</span>
        <span class="n">src</span> <span class="o">+=</span> <span class="s1">&#39;print(summary(model))</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">src</span></div>


    <span class="k">def</span> <span class="nf">_process_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_vals</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">pred_columns</span><span class="p">,</span> <span class="n">group_levels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Process a single data chunk. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sel_labels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="p">,</span> <span class="n">chunk_vals</span><span class="p">))</span>
            <span class="n">imageid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sel_labels</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_fix</span><span class="o">.</span><span class="n">_imageid</span><span class="p">])</span>
            <span class="n">tmpdf</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">pred_columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regionset</span><span class="p">[</span><span class="n">imageid</span><span class="p">])))</span>

            <span class="c1"># groupby returns a single string if only one chunk columns is selected</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">chunk_vals</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">tuple</span><span class="p">:</span>
                <span class="n">chunk_vals</span> <span class="o">=</span> <span class="p">(</span><span class="n">chunk_vals</span><span class="p">,)</span>

            <span class="c1"># Fixations</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fix</span><span class="o">.</span><span class="n">select_fix</span><span class="p">(</span><span class="n">sel_labels</span><span class="p">)</span>

            <span class="c1"># Chunk and region values</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="p">:</span>
                <span class="n">tmpdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Region ID and numbering</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">regionset</span><span class="o">.</span><span class="n">is_global</span><span class="p">:</span>
                <span class="n">tmpdf</span><span class="o">.</span><span class="n">regionid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regionset</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">regionset</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">imageid</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">regionid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
                <span class="n">tmpdf</span><span class="o">.</span><span class="n">regionno</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regionset</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">regionset</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">imageid</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">regionno</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmpdf</span><span class="o">.</span><span class="n">regionid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regionset</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">regionset</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">imageid</span> <span class="o">==</span> <span class="n">imageid</span><span class="p">]</span><span class="o">.</span><span class="n">regionid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
                <span class="n">tmpdf</span><span class="o">.</span><span class="n">regionno</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regionset</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">regionset</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">imageid</span> <span class="o">==</span> <span class="n">imageid</span><span class="p">]</span><span class="o">.</span><span class="n">regionno</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

            <span class="c1"># Fixated and non-fixated regions</span>
            <span class="k">if</span> <span class="s1">&#39;fixated&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dv_type</span><span class="p">:</span>
                <span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;dvFix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regionset</span><span class="o">.</span><span class="n">fixated</span><span class="p">(</span><span class="n">subset</span><span class="p">,</span> <span class="n">imageid</span><span class="o">=</span><span class="n">imageid</span><span class="p">,</span> <span class="n">exclude_first</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exclude_first_fix</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;count&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dv_type</span><span class="p">:</span>
                <span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;dvCount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regionset</span><span class="o">.</span><span class="n">fixated</span><span class="p">(</span><span class="n">subset</span><span class="p">,</span> <span class="n">imageid</span><span class="o">=</span><span class="n">imageid</span><span class="p">,</span> <span class="n">exclude_first</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exclude_first_fix</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Simple per-image features</span>
            <span class="k">for</span> <span class="n">feat_col</span><span class="p">,</span> <span class="n">feat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">tmpdf</span><span class="p">[</span><span class="n">feat_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">feat</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">imageid</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_features</span><span class="p">)</span>

            <span class="c1"># Feature group comparisons</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">levels</span> <span class="ow">in</span> <span class="n">group_levels</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">gc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_features</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">tmpdf</span><span class="p">[</span><span class="n">gc</span><span class="p">]</span> <span class="o">=</span> <span class="n">levels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                        <span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">_val&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gc</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp_features</span><span class="p">[</span><span class="n">gc</span><span class="p">][</span><span class="n">levels</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">imageid</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_features</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">tmpdf</span>


<div class="viewcode-block" id="FixationModel.update"><a class="viewcode-back" href="../../gridfix.html#gridfix.model.FixationModel.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Update predictor matrix from features (this may take a while).</span>

<span class="sd">        Args:</span>
<span class="sd">            progress (boolean): if True, print model creation progress</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Output DF columns</span>
        <span class="n">pred_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;regionid&#39;</span><span class="p">,</span> <span class="s1">&#39;regionno&#39;</span><span class="p">,</span> <span class="s1">&#39;dvFix&#39;</span><span class="p">]</span>
        <span class="n">pred_columns</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">cf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp_features</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">pred_columns</span> <span class="o">+=</span> <span class="p">[</span><span class="n">cf</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">_val&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cf</span><span class="p">)]</span>

        <span class="n">pred_new</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">pred_columns</span><span class="p">)</span>

        <span class="n">splitdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fix</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="p">)</span>

        <span class="n">group_levels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp_features</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
            <span class="n">group_levels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">groups</span><span class="p">))</span>

        <span class="c1"># Process individual chunks</span>
        <span class="k">for</span> <span class="n">chunk_vals</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">splitdata</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">progress</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">chunk_vals</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_chunk</span><span class="p">(</span><span class="n">chunk_vals</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">pred_columns</span><span class="p">,</span> <span class="n">group_levels</span><span class="p">)</span>
            <span class="n">pred_new</span> <span class="o">=</span> <span class="n">pred_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pred</span> <span class="o">=</span> <span class="n">pred_new</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_consistent</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span>     <span class="c1"># rebuild duration</span></div>
        

<div class="viewcode-block" id="FixationModel.add_feature"><a class="viewcode-back" href="../../gridfix.html#gridfix.model.FixationModel.add_feature">[docs]</a>    <span class="k">def</span> <span class="nf">add_feature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add a feature to the model.</span>

<span class="sd">        Args:</span>
<span class="sd">            feature (Feature): Feature object to add</span>
<span class="sd">            label (str): label and output column name for this feature</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Generate unique feature label</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feat_label</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

        <span class="c1"># Check feature length</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regionset</span><span class="p">):</span>
            <span class="n">w</span> <span class="o">=</span> <span class="s1">&#39;Could not add feature &quot;</span><span class="si">{:s}</span><span class="s1">&quot;: invalid length (</span><span class="si">{:d}</span><span class="s1"> instead of </span><span class="si">{:d}</span><span class="s1">)!&#39;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regionset</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_consistent</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="FixationModel.add_comparison"><a class="viewcode-back" href="../../gridfix.html#gridfix.model.FixationModel.add_comparison">[docs]</a>    <span class="k">def</span> <span class="nf">add_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">codes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add a feature comparison group to the model.</span>

<span class="sd">        This generates a long-style predictor matrix for the specified features,</span>
<span class="sd">        needed to compare e.g. different saliency maps in their relative effects.</span>

<span class="sd">        Args:</span>
<span class="sd">            features (list): list of Feature objects to combine into a group</span>
<span class="sd">            codes (list): numeric codes to use in &quot;dummy coding&quot;, e.g. [0, 1, 2]</span>
<span class="sd">            label (str): label and output column name for this feature group</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Generate unique group label</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">g_label</span> <span class="o">=</span> <span class="s1">&#39;fC&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>

            <span class="k">while</span> <span class="n">g_label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp_features</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">suffix</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">g_label</span> <span class="o">=</span> <span class="s1">&#39;fC&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>

        <span class="c1"># Generate dummy codes if necessary</span>
        <span class="k">if</span> <span class="n">codes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">codes</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">codes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">codes</span><span class="p">]</span>

        <span class="n">comp</span> <span class="o">=</span> <span class="p">{</span><span class="n">codes</span><span class="p">[</span><span class="n">c</span><span class="p">]:</span> <span class="n">f</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">features</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comp_features</span><span class="p">[</span><span class="n">g_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_consistent</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="FixationModel.save"><a class="viewcode-back" href="../../gridfix.html#gridfix.model.FixationModel.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">pred</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pred_pickle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">src_comments</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
             <span class="n">optimizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">random_slopes</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Saves the predictor matrix to a CSV text file.</span>

<span class="sd">        Args:</span>
<span class="sd">            basename (str): base filename to save to, without extension</span>
<span class="sd">            sep (str): item separator, default TAB</span>
<span class="sd">            pred (boolean): if True, output predictor matrix as CSV</span>
<span class="sd">            pred_pickle (boolean): if True, also save predictors to Pickle object</span>
<span class="sd">            src (boolean): if True, output r source code file for lme4</span>
<span class="sd">            src_comments (boolean): if True, add comments to source code</span>
<span class="sd">            precision (int): number of decimal places for CSV (default: 10)</span>
<span class="sd">            optimizer (str): optional optimizer to pass to R glmer()</span>
<span class="sd">            fixed (list): list of column names (strings) to add as fixed factors</span>
<span class="sd">            random (list): list of column names (strings) to add as random factors</span>
<span class="sd">            random_slopes (boolean): also add random slopes to generated R code</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consistent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">pred</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">LooseVersion</span><span class="p">(</span><span class="n">pandas_version</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">LooseVersion</span><span class="p">(</span><span class="s1">&#39;0.17.1&#39;</span><span class="p">):</span>
                <span class="c1"># compression supported from 0.17.1</span>
                <span class="n">f_pred</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">.csv.gz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">predictors</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">f_pred</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;%.</span><span class="si">{:d}</span><span class="s1">f&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;gzip&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f_pred</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">predictors</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">f_pred</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;%.</span><span class="si">{:d}</span><span class="s1">f&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">pred_pickle</span><span class="p">:</span>
            <span class="n">f_pred</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">.pkl&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predictors</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">f_pred</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">f_src</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">.R&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>
            <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_source</span><span class="p">(</span><span class="n">comments</span><span class="o">=</span><span class="n">src_comments</span><span class="p">,</span> <span class="n">datafile</span><span class="o">=</span><span class="n">f_pred</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
                                <span class="n">fixed</span><span class="o">=</span><span class="n">fixed</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="n">random</span><span class="p">,</span> <span class="n">random_slopes</span><span class="o">=</span><span class="n">random_slopes</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f_src</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">sf</span><span class="p">:</span>
                <span class="n">sf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">src</span><span class="p">)</span></div></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The gridfix modules cannot be called directly. Please use one of the included tools, e.g. gridmap.&#39;</span><span class="p">)</span>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Immo Schuetz.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>